<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Deezer QR Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 2em;
            background-color: #f4f4f4;
        }

        #qr-reader {
            width: 300px;
            margin: auto;
        }

        audio {
            margin-top: 1em;
        }
    </style>
</head>

<body>
    <h1>Deezer QR Scanner</h1>
    <div id="qr-reader"></div>
    <p id="status">Scanne einen Deezer QR-Code…</p>
    <audio id="audio" controls autoplay></audio>

    <script>
        const audioElement = document.getElementById('audio');
        const statusElement = document.getElementById('status');

        function extractDeezerTrackId(url) {
            const match = url.match(/deezer\.com\/track\/(\d+)/);
            return match ? match[1] : null;
        }

        async function fetchDeezerPreview(trackId) {
            try {
                const response = await fetch(`https://api.deezer.com/track/${trackId}?output=jsonp`);
                const text = await response.text();
                const json = JSON.parse(text.replace(/^.+?\(/, '').replace(/\);?$/, ''));
                return json.preview;
            } catch (error) {
                console.error('Fehler beim Abrufen der Preview:', error);
                return null;
            }
        }

        async function handleScanSuccess(decodedText) {
            if (!decodedText.includes("deezer.com/track/")) {
                statusElement.textContent = "Kein gültiger Deezer-Link.";
                return;
            }

            statusElement.textContent = `Track-Link erkannt: ${decodedText}`;
            const trackId = extractDeezerTrackId(decodedText);

            if (!trackId) {
                statusElement.textContent = "Track-ID konnte nicht extrahiert werden.";
                return;
            }

            statusElement.textContent = `Lade Preview für Track ${trackId}…`;
            const previewUrl = await fetchDeezerPreview(trackId);

            if (previewUrl) {
                audioElement.src = previewUrl;
                audioElement.play();
                statusElement.textContent = "Preview wird abgespielt.";
            } else {
                statusElement.textContent = "Preview konnte nicht geladen werden.";
            }
        }

        new Html5Qrcode("qr-reader").start(
            { facingMode: "environment" },
            {
                fps: 10,
                qrbox: 250
            },
            handleScanSuccess,
            (errorMessage) => {
                // Fehler beim Scannen ignorieren
            }
        );
    </script>
</body>

</html>